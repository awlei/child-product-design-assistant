# 本地知识库说明

## 概述

本地知识库是"儿童产品设计助手"的核心功能之一，当AI服务不可用时，应用会自动使用本地法规数据库生成设计建议。这确保了即使在离线环境或API服务中断的情况下，用户依然能够获得专业的设计指导。

## 数据来源

本知识库基于以下官方法规和技术文档整理：

### 1. ECE R129 (i-Size)
- **文档**: UN Regulation No. 129 (R129r4e)
- **发布机构**: UNECE (联合国欧洲经济委员会)
- **状态**: 当前推荐使用的先进标准
- **主要特点**: 基于儿童身高，强制ISOFIX和侧撞保护

### 2. FMVSS 213
- **文档**: Federal Motor Vehicle Safety Standard 213
- **发布机构**: NHTSA (美国国家公路交通安全管理局)
- **状态**: 美国联邦标准，新版213a加强侧撞保护
- **主要特点**: 基于体重，支持LATCH和车辆安全带

### 3. ECE R44/04
- **文档**: UN Regulation No. 44 (R44r4e)
- **发布机构**: UNECE
- **状态**: 逐步淘汰，将被R129完全取代
- **主要特点**: 基于体重分组，分类清晰

### 4. GPS R016 (UN Regulation No. 16)
- **文档**: UN Regulation No. 16 (R016r10e)
- **发布机构**: UNECE
- **用途**: 提供儿童人体测量数据
- **数据**: 坐高、肩宽、臀宽、肩高等关键尺寸

## 数据结构

### 标准数据

每个标准包含以下字段：

```json
{
  "name": "标准名称",
  "description": "标准描述",
  "effective_date": "生效日期",
  "status": "当前状态",
  "key_requirements": {
    "要求1": "说明",
    "要求2": "说明"
  },
  "height_groups": [],  // R129专用
  "weight_groups": [],  // R44和FMVSS 213专用
  "injury_criteria": {},  // 伤害指标
  "safety_recommendations": []  // 安全建议
}
```

### 人体测量数据

基于GPS R016标准，包含：

```json
{
  "stature": 40,  // 身高
  "sitting_height": 26,  // 坐高
  "shoulder_breadth": 17,  // 肩宽
  "hip_breadth": 14,  // 臀宽
  "shoulder_height_min": 18  // 肩高（最小）
}
```

### 功能特性数据

包含常用安全功能的技术规格：

```json
{
  "five_point_harness": {
    "name": "五点式安全带",
    "description": "分散碰撞冲击力，防止儿童滑脱",
    "technical_specs": "肩带宽度25-32mm，配备防滑锁定器"
  }
}
```

## Fallback机制

### 触发条件

本地知识库会在以下情况自动启用：

1. **API Key未配置**：`.env`文件中`DOUBAO_API_KEY`为空
2. **API服务失败**：请求豆包API失败或超时
3. **网络问题**：无法连接到AI服务
4. **API配额耗尽**：达到API调用限制

### 工作流程

```
用户生成报告请求
       ↓
检查AI服务可用性
       ↓
    ┌──┴──┐
    │     │
  可用  不可用
    │     │
    ↓     ↓
调用AI  使用本地知识库
    │     │
    └──┬──┘
       ↓
  流式输出报告
       ↓
  显示数据来源标签
```

### 用户体验

- **无感知切换**：用户无需手动选择，系统自动切换
- **流式输出**：模拟AI打字效果，体验一致
- **数据来源标识**：界面显示"本地知识库"标签，透明化处理
- **完整内容**：包含标准概述、技术要求、安全建议等全部内容

## 功能对比

| 功能 | AI服务 | 本地知识库 |
|------|--------|------------|
| 标准数据 | ✅ | ✅ |
| 人体测量数据 | ✅ | ✅ |
| 技术建议 | ✅ | ✅ |
| 品牌参数对比 | ✅ | ❌ |
| 最新标准更新 | ✅ | ❌ |
| 个性化建议 | ✅ | ❌ |
| 法规审核 | ✅ | ❌ |
| 离线使用 | ❌ | ✅ |
| 响应速度 | 2-5秒 | <1秒 |
| 需要API Key | ✅ | ❌ |

## 使用示例

### 示例1：ECE R129标准

**输入**：
- 标准：ECE R129
- 身高范围：40-105cm

**输出**：
```
# ECE R129 (i-Size) - 设计建议

*数据来源: local_knowledge_base* | *置信度: 85%*

---

## 标准概述

**标准名称**: ECE R129 (i-Size)
**描述**: 当前欧洲最先进的儿童安全座椅标准，主要依据儿童身高
**生效日期**: 2013-07-09
**状态**: 当前推荐使用的先进标准

## 关键要求

**height_based**: 基于儿童身高（40cm~150cm）
**isofix_required**: 强制使用ISOFIX接口
**rear_facing_min**: 后向乘坐至少至15个月
**side_impact**: 强制侧撞保护

## 适用分组

**分组**: 40-105cm
**体重/身高**: 40-105cm
**年龄段**: 0-15个月
**安装方式**: ISOFIX + 支撑腿

**核心特性**:
- 五点式安全带
- 可调节头枕（5-7档）
- 侧撞保护系统

**技术规格**:
- seat_angle: 45-50度（后向）
- harness_width: 25-28mm
- shoulder_width: 230-280mm

## 伤害指标要求

**HIC15**: ≤ 700
**HIC36**: ≤ 1000
**Nij**: ≤ 1.0
**chest_acceleration**: ≤ 55g

## 安全建议

1. 必须使用已通过ECE R129认证的产品
2. 后向乘坐至少至15个月或身高105cm
3. 定期检查ISOFIX接口的连接状态
4. 根据儿童身高及时调整头枕高度

---

**注意**: 本建议基于本地法规数据库生成，仅供参考。实际产品设计请遵循最新官方标准和认证要求。
```

### 示例2：FMVSS 213标准

**输入**：
- 标准：FMVSS 213
- 体重范围：9-18kg

**输出**：
```
# FMVSS 213 - 设计建议

*数据来源: local_knowledge_base* | *置信度: 85%*

---

## 标准概述

**标准名称**: FMVSS 213
**描述**: 美国联邦儿童约束系统标准，主要依据体重
**生效日期**: 2024-11-01
**状态**: 美国联邦标准，新版213a强制侧撞保护

## 关键要求

**weight_based**: 基于体重分组
**lap_shoulder_belt**: 可使用车辆安全带固定
**side_impact**: 新版213a强制侧撞保护

## 适用分组

**分组**: Group 1
**体重/身高**: 9-18kg
**年龄段**: 9个月-4岁
**安装方式**: ISOFIX + 顶部固定带/车辆安全带

**核心特性**:
- 五点式安全带
- 可调节头枕（5-6档）
- 侧撞保护（新版）

## 伤害指标要求

**frontal**:
  - HIC: ≤ 1000
  - Nij: ≤ 1.0
  - chest_acceleration: ≤ 60g

**side**:
  - head_injury_criteria: ≤ 890
  - chest_acceleration: ≤ 60g
  - abdominal_force: ≤ 2.5kN

---

**注意**: 本建议基于本地法规数据库生成，仅供参考。实际产品设计请遵循最新官方标准和认证要求。
```

## 技术实现

### 数据文件

位置：`public/data/local-knowledge-base.json`

### 读取逻辑

```typescript
import { readFileSync } from 'fs';
import { join } from 'path';

const knowledgeBasePath = join(process.cwd(), 'public/data/local-knowledge-base.json');
const fileContent = readFileSync(knowledgeBasePath, 'utf-8');
const knowledgeBase = JSON.parse(fileContent);
```

### 生成建议流程

1. 解析用户请求（标准、身高/体重范围）
2. 从知识库中提取对应标准
3. 根据范围匹配适用分组
4. 整理标准概述、技术要求、安全建议
5. 人体测量数据匹配
6. 格式化为Markdown输出
7. 模拟流式响应

### 流式响应

```typescript
const chars = markdownContent.split('');
for (let i = 0; i < chars.length; i += 5) {
  const chunk = chars.slice(i, i + 5).join('');
  controller.enqueue(encoder.encode(`data: ${JSON.stringify({ content: chunk })}\n\n`));
  await new Promise(resolve => setTimeout(resolve, 30));
}
```

## 优势与局限

### 优势

1. **离线可用**：首次加载后无需网络连接
2. **响应迅速**：<1秒完成生成
3. **数据可靠**：基于官方法规文档
4. **无额外成本**：无需API Key和调用费用
5. **稳定可靠**：不受网络或服务中断影响

### 局限

1. **内容固定**：无法获取最新标准更新
2. **有限互动**：无法进行个性化问答
3. **无联网搜索**：无法获取品牌参数对比
4. **无法审核**：无法进行法规合规性审核
5. **置信度限制**：基于预设规则，非AI推理

## 更新维护

### 数据更新周期

建议每年更新一次，确保包含最新的法规变化。

### 更新内容

1. 新标准发布（如R129修订版）
2. 伤害指标更新
3. 测试方法变更
4. 新增功能要求

### 更新步骤

1. 收集最新官方文档
2. 提取关键数据
3. 更新JSON文件
4. 测试验证
5. 提交代码

## 未来规划

### V8.3.0计划

1. **数据版本管理**：支持多版本知识库切换
2. **增量更新**：支持在线更新知识库
3. **多语言支持**：中英文对照
4. **更多标准**：新增GB 27887（中国标准）
5. **搜索功能**：全文检索标准内容

### V8.4.0计划

1. **智能推荐**：基于用户历史数据推荐
2. **图表可视化**：人体尺寸图表展示
3. **对比工具**：多标准对比分析
4. **测试用例**：内置测试场景和假人数据

## 常见问题

### Q1: 本地知识库的准确度如何？

A: 本知识库基于官方法规文档整理，准确度约85%。建议结合AI服务使用，获得更全面的信息。

### Q2: 如何更新知识库数据？

A: 编辑`public/data/local-knowledge-base.json`文件，然后重新构建应用。

### Q3: 本地知识库是否包含所有标准？

A: 目前包含ECE R129、FMVSS 213、ECE R44三个主要标准。未来会逐步增加其他标准。

### Q4: 如何知道使用的是AI还是本地知识库？

A: 界面上会显示"本地知识库"标签。AI服务不显示此标签。

### Q5: 本地知识库能否离线使用？

A: 是的，首次加载后数据会缓存，可以完全离线使用。

## 技术支持

如有问题或建议，请联系开发团队。

---

**最后更新**: 2026-01-27
**版本**: 1.0.0
