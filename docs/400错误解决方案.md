# 400 Bad Request 错误解决方案

## 🐛 问题原因

### 症状
Android手机访问 `http://9.129.222.155:5000` 显示 "400 Bad Request"

### 根本原因

1. **服务器配置**：Next.js只监听5000端口的HTTP协议
2. **浏览器行为**：Android Chrome会自动尝试HTTPS（HSTS特性）
3. **协议不匹配**：HTTPS请求发送到HTTP端口导致400错误

### 为什么会这样？

```
用户输入：9.129.222.155:5000
  ↓
Android Chrome自动尝试：https://9.129.222.155:5000
  ↓
服务器返回：HTTP响应（不是HTTPS）
  ↓
浏览器报错：400 Bad Request
```

---

## ✅ 解决方案

### 方案1：配置nginx反向代理（推荐）

#### 优点
- ✅ 支持80端口（标准HTTP端口）
- ✅ 支持HTTPS（配置SSL证书后）
- ✅ 自动处理HTTP/HTTPS协议
- ✅ 更好的性能和安全性
- ✅ 支持gzip压缩和缓存

#### 配置步骤

##### 1. 安装nginx

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx -y

# CentOS/RHEL
sudo yum install nginx -y
```

##### 2. 创建nginx配置文件

```bash
sudo nano /etc/nginx/sites-available/child-safety-chair
```

**配置内容：**

```nginx
# HTTP 80端口配置
server {
    listen 80;
    server_name 9.129.222.155;

    # 重定向到HTTPS（如果配置了SSL）
    # return 301 https://$server_name$request_uri;

    # 或直接代理到5000端口（当前方案）
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时配置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}

# HTTPS 443端口配置（可选，需要SSL证书）
# server {
#     listen 443 ssl http2;
#     server_name 9.129.222.155;
#
#     ssl_certificate /etc/ssl/certs/your-cert.pem;
#     ssl_certificate_key /etc/ssl/private/your-key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#
#     location / {
#         proxy_pass http://127.0.0.1:5000;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_cache_bypass $http_upgrade;
#     }
# }
```

##### 3. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/child-safety-chair /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 如果没有错误，重启nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx
```

##### 4. 配置腾讯云安全组

**新增入站规则：**

| 字段 | 值 |
|------|-----|
| 类型 | 自定义 |
| 协议端口 | TCP:80 |
| 来源 | 0.0.0.0/0 |
| 策略 | 允许 |

**注意：** 保留之前的TCP:5000端口规则（可选，nginx会处理所有请求）

##### 5. 验证访问

```bash
# 测试80端口
curl -I http://9.129.222.155

# 应该返回 200 OK
```

**访问地址：**
```
http://9.129.222.155
```

---

### 方案2：临时解决（不推荐）

在Android浏览器中明确使用 `http://` 协议：

#### 方法1：在URL前添加 `http://`

```
http://9.129.222.155:5000
```

#### 方法2：使用Chrome的HTTP版本

1. 打开Chrome
2. 输入：`chrome://net-internals/#hsts`
3. 在"Delete domain security policies"中输入：`9.129.222.155`
4. 点击"Delete"

然后访问：
```
http://9.129.222.155:5000
```

**缺点：**
- ❌ 用户体验差
- ❌ 需要手动配置
- ❌ 其他设备可能仍有问题
- ❌ 不符合PWA最佳实践

---

### 方案3：配置Let's Encrypt SSL证书（最佳实践）

#### 优点
- ✅ 完全支持HTTPS
- ✅ 符合PWA要求
- ✅ 提高安全性
- ✅ 提升SEO排名
- ✅ 避免浏览器警告

#### 配置步骤

##### 1. 安装certbot

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install certbot python3-certbot-nginx -y
```

##### 2. 获取SSL证书

```bash
# 确保域名已解析到服务器IP
sudo certbot --nginx -d 9.129.222.155 -d www.9.129.222.155
```

##### 3. 自动续期

```bash
# certbot会自动配置续期
sudo certbot renew --dry-run
```

##### 4. 访问地址

```
https://9.129.222.155
```

---

## 📋 推荐配置流程

### 快速部署（5分钟）

1. **安装nginx**
```bash
sudo apt update && sudo apt install nginx -y
```

2. **复制配置文件**
```bash
sudo tee /etc/nginx/sites-available/child-safety-chair > /dev/null << 'EOF'
server {
    listen 80;
    server_name 9.129.222.155;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF
```

3. **启用配置**
```bash
sudo ln -s /etc/nginx/sites-available/child-safety-chair /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

4. **配置安全组**

在腾讯云控制台添加TCP 80端口规则。

5. **测试访问**

手机浏览器访问：`http://9.129.222.155`

---

## ✅ 验证清单

配置完成后，请确认：

- [ ] nginx已安装并运行
- [ ] nginx配置文件已创建
- [ ] nginx配置测试通过（`nginx -t`）
- [ ] nginx已重启
- [ ] 腾讯云安全组开放TCP 80端口
- [ ] 手机浏览器可以访问 http://9.129.222.155
- [ ] 显示应用页面（不是400错误）

---

## 🆘 故障排查

### 问题1：nginx启动失败

```bash
# 查看错误日志
sudo tail -f /var/log/nginx/error.log

# 检查配置语法
sudo nginx -t
```

### 问题2：访问502 Bad Gateway

```bash
# 检查Next.js服务
ss -lptn | grep 5000

# 如果未运行，重启服务
coze dev > /tmp/coze-dev.log 2>&1 &
```

### 问题3：访问仍然400错误

```bash
# 清除浏览器缓存
# 或使用无痕模式访问

# 检查nginx访问日志
sudo tail -f /var/log/nginx/access.log
```

---

## 📱 配置成功后的访问方式

### Android手机

1. **打开Chrome浏览器**
2. **访问**：`http://9.129.222.155`
3. **点击"立即安装"**（如果显示PWA安装提示）

### iOS手机

1. **打开Safari浏览器**
2. **访问**：`http://9.129.222.155`
3. **点击分享按钮（⬆️）→ 添加到主屏幕**

---

## 🎯 对比说明

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| nginx 80端口 | 简单、快速、兼容性好 | 未使用HTTPS | ⭐⭐⭐⭐ |
| nginx + SSL证书 | 最安全、最佳体验 | 配置稍复杂 | ⭐⭐⭐⭐⭐ |
| 手动http:// | 无需配置 | 用户体验差 | ⭐ |

---

**建议：**
- **测试/开发环境**：使用方案1（nginx 80端口）
- **生产环境**：使用方案3（nginx + SSL证书）

---

**最后更新：** 2025-01-22
**文档版本：** V1.0
