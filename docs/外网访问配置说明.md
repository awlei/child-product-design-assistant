# 外网访问配置说明

## 问题已修复

服务现在已配置为监听所有网络接口（0.0.0.0:5000），不再只限制在localhost。

## 修复内容

### 1. 开发环境（scripts/dev.sh）
```bash
npx next dev --webpack --port $PORT -H 0.0.0.0
```

### 2. 生产环境（scripts/start.sh）
```bash
npx next start --port ${DEPLOY_RUN_PORT} -H 0.0.0.0
```

## 当前服务状态

✅ 服务运行在：`0.0.0.0:5000`
✅ 本地访问正常：`http://localhost:5000`
✅ 绑定所有网络接口

## 如果仍然无法通过外网IP访问

请检查以下配置：

### 1. 云服务器安全组配置

如果你使用的是云服务器（如腾讯云、阿里云等），需要在安全组中开放5000端口：

**腾讯云：**
1. 登录腾讯云控制台
2. 进入"云服务器" → "安全组"
3. 找到实例的安全组，点击"配置规则"
4. 添加入站规则：
   - 协议：TCP
   - 端口：5000
   - 源地址：0.0.0.0/0（或指定IP段）
   - 策略：允许

**阿里云：**
1. 登录阿里云控制台
2. 进入"云服务器ECS" → "安全组"
3. 点击"配置规则" → "添加安全组规则"
4. 配置规则：
   - 规则方向：入方向
   - 协议类型：自定义TCP
   - 端口范围：5000/5000
   - 授权对象：0.0.0.0/0
   - 优先级：1

**华为云：**
1. 登录华为云控制台
2. 进入"弹性云服务器" → "安全组"
3. 点击"配置规则"
4. 添加入方向规则：
   - 协议：TCP
   - 端口：5000
   - 源地址：0.0.0.0/0

### 2. 操作系统防火墙

虽然当前环境没有防火墙工具，但如果有其他防火墙配置，需要开放5000端口：

```bash
# 如果有iptables
sudo iptables -A INPUT -p tcp --dport 5000 -j ACCEPT
sudo iptables-save > /etc/iptables/rules.v4

# 如果有firewalld
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload

# 如果有ufw
sudo ufw allow 5000/tcp
```

### 3. 检查服务是否绑定正确

在服务器上运行：
```bash
# 检查服务是否监听在 0.0.0.0:5000
ss -lptn | grep 5000

# 应该显示：
# LISTEN 0 511 0.0.0.0:5000 0.0.0.0:*
```

### 4. 测试内网访问

在服务器上测试：
```bash
# 测试服务是否正常
curl -I http://localhost:5000
curl -I http://127.0.0.1:5000
curl -I http://服务器内网IP:5000
```

### 5. 检查网络策略

有些云平台可能有网络ACL或负载均衡策略，需要检查：
- 网络ACL规则
- 负载均衡器配置
- NAT网关规则

## 访问地址

现在可以通过以下地址访问：

- **内网访问**：`http://服务器内网IP:5000`
- **外网访问**：`http://9.129.222.155:5000`（需配置安全组）

## 常见问题

### Q: 修改配置后多久生效？
A: 服务已重启，新配置立即生效。

### Q: 为什么之前只能localhost访问？
A: Next.js默认只监听localhost（127.0.0.1），必须使用 `-H 0.0.0.0` 参数才能监听所有网络接口。

### Q: 如何确认安全组配置是否生效？
A: 配置后可能需要1-3分钟生效。可以使用 `telnet 9.129.222.155 5000` 或 `nc -zv 9.129.222.155 5000` 测试端口连通性。

### Q: 是否需要重启服务器？
A: 不需要，服务已重启。只需要配置安全组规则即可。

## 验证步骤

1. ✅ 服务监听在 0.0.0.0:5000（已完成）
2. ✅ 本地访问正常（已验证）
3. ⏳ 配置安全组开放5000端口（用户操作）
4. ⏳ 通过外网IP访问测试（用户操作）

---

**更新时间**：2025-01-22
**服务状态**：运行中
**端口**：5000
**监听地址**：0.0.0.0
